# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### 1) Create a Secret Using kubectl
Using command we can create a secret:
```
kubectl create secret generic my-secret --from-literal=key1=value1
kubectl create secret generic my-secret --from-literal=k8secret="password"
```
Output:
```
secret/my-secret created
```

### 2) Verify and Decode Your Secret:
Command to verify the secret:
```
kubectl get secret my-secret
```
Output:
```
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      94s
```
Or to get full data:
```
kubectl describe secret my-secret
```
Output:
```
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
k8secret:  8 bytes
```

To see the secret use the command:
```
kubectl get secret my-secret -o jsonpath='{.data.*}' | base64 -d
```
Output:
```
password
```

### 3) Manage Secrets with Helm
Now I create a secrets.yaml in helm-app-python/templates.

Lets encrypt the password:
```
echo -n 'my-secret-password' | base64
```
Output:
```
bXktc2VjcmV0LXBhc3N3b3Jk
```

Added to secrets.yaml:
```
apiVersion: v1
kind: Secret
metadata:
  name: k8secret
type: Opaque
data:
  password: bXktc2VjcmV0LXBhc3N3b3Jk
```

Added to deployment.yaml:
```
env:
- name: "MY_PASS"
valueFrom:
    secretKeyRef:
    name: k8secret
    key: password
```

Command:
```
kubectl get po
```
Output:
```
NAME                                          READY   STATUS    RESTARTS   AGE
python-app-helm-app-python-74fb87bfdc-jpnpk   1/1     Running   0          2m59s
```

Command:
```
kubectl exec python-app-helm-app-python-74fb87bfdc-jpnpk -- printenv | grep MY_PASS
```
Output:
```
MY_PASS=my-secret-password
```

## Task 2: Vault Secret Management System

### 1) Install Vault Using Helm Chart


Command:
```
helm repo add hashicorp https://helm.releases.hashicorp.com
```
Output:
```
"hashicorp" has been added to your repositories
```


Command:
```
helm repo update
```
Output:
```
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. ⎈Happy Helming!⎈
```


Command:
```
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```
Output:
```
NAME: vault
LAST DEPLOYED: Tue Nov 14 02:08:06 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

Command:
```
kubectl get pods
```
Output:
```
NAME                                                  READY   STATUS              RESTARTS   AGE
javascript-app-helm-app-javascript-79c7bbf87d-gvhvz   1/1     Running             0          12m
python-app-helm-app-python-556699bfcc-2sjjx           1/1     Running             0          13m
vault-0                                               0/1     ContainerCreating   0          8s
vault-agent-injector-5cd8b87c6c-nzb6w                 0/1     ContainerCreating   0          8s
```

### 2) Follow the Tutorial with Your Helm Chart:

Command:
```
kubectl exec -it vault-0 -- /bin/sh
```

Command:
```
vault secrets enable -path=internal kv-v2
```
Output:
```
Success! Enabled the kv-v2 secrets engine at: internal/
```

Command:
```
vault kv put internal/database/config username="secret-username" password="secret-password"
```
Output:
```
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T23:41:16.546875589Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

Command:
```
vault kv get internal/database/config
```
Output:
```
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-13T23:41:16.546875589Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    secret-password
username    secret-username
```



Command:
```
vault auth enable kubernetes
```
Output:
```
Success! Enabled kubernetes auth method at: kubernetes/
```

Command:
```
vault write auth/kubernetes/config \
      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```
Output:
```
Success! Data written to: auth/kubernetes/config
```

Command:
```
vault policy write internal-app - <<EOF
path "internal/data/database/config" {
   capabilities = ["read"]
}
EOF
```
Output:
```
Success! Uploaded policy: internal-app
```

Command:
```
vault write auth/kubernetes/role/internal-app \
      bound_service_account_names=internal-app \
      bound_service_account_namespaces=default \
      policies=internal-app \
      ttl=24h
```
Output:
```
Success! Data written to: auth/kubernetes/role/internal-app
```

Command:
```
kubectl get serviceaccounts
```
Output:
```
NAME                                 SECRETS   AGE
default                              0         14d
javascript-app-helm-app-javascript   0         52m
python-app-helm-app-python           0         53m
vault                                0         40m
vault-agent-injector                 0         40m
```

Command:
```
kubectl create sa internal-app
```
Output:
```
serviceaccount/internal-app created
```

Changed values.yaml.
```
serviceAccount:
    create: false
    name: "internal-app"
```
Added labels.
```
podAnnotations:
  vault.hashicorp.com/agent-inject: 'true'
  vault.hashicorp.com/role: 'internal-app'
  vault.hashicorp.com/agent-inject-secret-my-config.txt: 'internal/data/database/config'

```
Restarted the apps.

Command:
```
kubectl get pods
```
Output:
```
NAME                                                  READY   STATUS    RESTARTS   AGE
javascript-app-helm-app-javascript-79c7bbf87d-gvhvz   1/1     Running   0          93m
python-app-helm-app-python-6d4f8c86d6-zcplk           2/2     Running   0          2m1s
vault-0                                               1/1     Running   0          81m
vault-agent-injector-5cd8b87c6c-nzb6w                 1/1     Running   0          81m
```

Command:
```
kubectl exec -it python-app-helm-app-python-6d4f8c86d6-zcplk -- /bin/sh
```
Output:
```
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
```

Command:
```
/app $ cat /vault/secrets/my-config.txt
```
Output:
```
data: map[password:secret-password username:secret-username]
metadata: map[created_time:2023-11-13T23:41:16.546875589Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

Command:
```
/app $ df -h
```
Output:
```
Filesystem                Size      Used Available Use% Mounted on
overlay                  58.4G      9.9G     45.5G  18% /
tmpfs                    64.0M         0     64.0M   0% /dev
tmpfs                     7.7G      4.0K      7.7G   0% /vault/secrets
/dev/vda1                58.4G      9.9G     45.5G  18% /dev/termination-log
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/resolv.conf
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/hostname
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     7.7G     12.0K      7.7G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.8G         0      3.8G   0% /sys/firmware
```

Apply a template as described in the guide:
For this we need to add in values.yaml two lines into podAnnotations:
```
podAnnotations:
  vault.hashicorp.com/agent-inject-status: 'update'
  vault.hashicorp.com/agent-inject-template-my-config.txt: |
            {{- with secret "internal/data/database/config" -}}
            postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}arseniyrubtsov
            {{- end -}}
```

After updating the app, use the command:
```
kubectl get po
```
Output:
```
NAME                                                  READY   STATUS    RESTARTS   AGE
python-app-helm-app-python-55b8846554-t67st           2/2     Running   0          30s
vault-0                                               1/1     Running   0          20h
vault-agent-injector-5cd8b87c6c-nzb6w                 1/1     Running   0          20h
```

Command:
```
kubectl exec -it python-app-helm-app-python-55b8846554-t67st -- /bin/sh
```
Output:
```
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent, vault-agent-init (init)
/app $ 
```

Command:
```
/app $ cat /vault/secrets/my-config.txt
```
Output:
```
postgresql://secret-username:secret-passwordarseniyrubtsov
```

Command:
```
/app $ df -h
```
Output:
```
Filesystem                Size      Used Available Use% Mounted on
overlay                  58.4G      9.9G     45.5G  18% /
tmpfs                    64.0M         0     64.0M   0% /dev
/dev/vda1                58.4G      9.9G     45.5G  18% /dev/termination-log
tmpfs                   384.0M      4.0K    384.0M   0% /vault/secrets
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/resolv.conf
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/hostname
/dev/vda1                58.4G      9.9G     45.5G  18% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                   384.0M     12.0K    384.0M   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.8G         0      3.8G   0% /sys/firmware
```

## Bonus

### 2) Set Up Requests and Limits for CPU and Memory for Both Helm Charts

Uncommented resources in values.yaml in both apps:
```
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
```
To see them we can use command:
```
kubectl top pod python-app-helm-app-python-55b8846554-t67st
```
Part of the output:
```
Containers:
  helm-app-python:
    Container ID:   docker://16ddeb72b0575cb5914813ff05804189045831be801eea84e54e4be8a60ca0ac
    Image:          arseniy5443/moscowtime:latest
    Image ID:       docker-pullable://arseniy5443/moscowtime@sha256:8cdad1e7feee76a9f89284b84f882afe93c22fa99c744f57ccb6c95e6aca2d72
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 14 Nov 2023 22:18:14 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     200m
      memory:  256Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASS:  <set to the key 'password' in secret 'k8secretpython'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-s4zpv (ro)
      /vault/secrets from vault-secrets (rw)
```

### 3) Add Environment Variables for Your Containers for Both Helm Charts:

Added to values: (also added to other app)
```
secret:
  name: k8secretpython
  key: password
```

Added to secrets.yaml: (also added to other app)
```
apiVersion: v1
kind: Secret
metadata:
  name: k8secretpython
type: Opaque
data:
  password: bXktc2VjcmV0LXB5dGhvbg==
```

Added to _helpers.tlp: (also added to other app)
```
{{- define "helm-app-python.envsecrets" -}}
{{- if .Values.secret.name }}
- name: "MY_PASS"
  valueFrom:
    secretKeyRef:
      name: {{ .Values.secret.name }}
      key: {{ .Values.secret.key }}
{{- else }}
- name: "None"
  value: ""
{{- end }}
{{- end }}
```


Command:
```
kubectl get po
```
Output:
```
NAME                                                  READY   STATUS    RESTARTS   AGE
javascript-app-helm-app-javascript-79c7bbf87d-gvhvz   1/1     Running   0          109s
python-app-helm-app-python-556699bfcc-2sjjx           1/1     Running   0          2m47s
```

Command:
```
kubectl exec python-app-helm-app-python-556699bfcc-2sjjx -- printenv | grep MY_PASS
```
Output:
```
MY_PASS=my-secret-python
```


Command:
```
kubectl exec javascript-app-helm-app-javascript-79c7bbf87d-gvhvz -- printenv | grep MY_PASS
```
Output:
```
MY_PASS=my-secret-javascript
```


Command:
```
kubectl set env pods --all --list
```
Output:
```
# Pod javascript-app-helm-app-javascript-79c7bbf87d-gvhvz, container helm-app-javascript
# MY_PASS from secret k8secretjavascript, key password
# Pod python-app-helm-app-python-556699bfcc-2sjjx, container helm-app-python
# MY_PASS from secret k8secretpython, key password
```
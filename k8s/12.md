# Lab 12: Kubernetes ConfigMaps

## Task 1: Upgrade Application for Persistence

Updated apps.
```
@bp.route("/visits")
def show_visits():
    return str(REQUEST_COUNT.labels("GET", "/", 200)._value.get())
```

Updated in docker-compose in ansible folder in web_app role:
```
volumes:
     - './visits:/app/visits'
```

Tested.

Updated README.md in each app.

## Task 2: ConfigMap Implementation in helm-app-python

Created files folder and config.json inside.
Added data to config.json, created configmap manifest:
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: myconfigmap
data:
  config.json: |-
{{ .Files.Get "files/config.json" | indent 4}}
```

Updated values.yaml so deployment.yaml will get Volumes and VolumeMounts from it:
```
volumes:
  - name: config
    configMap:
      name: myconfigmap

volumeMounts:
  - name: config
    mountPath: "/config.json"
    subPath: config.json
    readOnly: true
```

Command:
```
kubectl get po
```
Output:
```
NAME                                         READY   STATUS    RESTARTS        AGE
python-app-helm-app-python-d4c7b9d9d-59ftx   2/2     Running   0               26s
vault-0                                      1/1     Running   1 (5d23h ago)   6d21h
vault-agent-injector-5cd8b87c6c-nzb6w        1/1     Running   1 (5d23h ago)   6d21h
```

Command:
```
kubectl exec python-app-helm-app-python-d4c7b9d9d-59ftx -- cat /config.json
```
Output:
```
Defaulted container "helm-app-python" out of: helm-app-python, vault-agent
{"python": "python"}
```

## Bonus

### 1) Implemented persistence logic in my bonus app.

```
app.get('/get-quote', (req, res) => {
  httpRequestCounter.inc({ method: 'GET', route: '/get-quote' });
  const randomQuote = getRandomQuote()
  countVisits = countVisits + 1;
  
  fs.writeFile("visits", countVisits.toString(), (err) => {
  });

  res.json({ quote: randomQuote })
})

app.get('/visits', (req, res) => {
  res.json(countVisits)
})
```

### 2) ConfigMap via Environment Variables:

Added to deployment.yaml:
```
envFrom:
- configMapRef:
    name: env-configmap
```

Created env-configmap.yaml:
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-configmap
data:
  ENV_VAR: "ENV_VAR_VALUE"
```

Command:
```
kubectl get po
```
Output:
```
NAME                                          READY   STATUS    RESTARTS     AGE
python-app-helm-app-python-6f5956b49f-w8t9p   2/2     Running   0            30s
vault-0                                       1/1     Running   1 (6d ago)   6d21h
vault-agent-injector-5cd8b87c6c-nzb6w         1/1     Running   1 (6d ago)   6d21h
```

Command:
```
kubectl exec python-app-helm-app-python-6f5956b49f-w8t9p -- env
```
Part of output: (3rd line from end our variable)
```
VAULT_PORT_8200_TCP_PORT=8200
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
PYTHON_APP_HELM_APP_PYTHON_PORT_5000_TCP=tcp://10.109.73.195:5000
PYTHON_APP_HELM_APP_PYTHON_PORT=tcp://10.109.73.195:5000
VAULT_PORT_8200_TCP_ADDR=10.104.79.3
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
PYTHON_APP_HELM_APP_PYTHON_PORT_5000_TCP_ADDR=10.109.73.195
VAULT_SERVICE_PORT=8200
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_PORT_HTTPS=443
VAULT_PORT_8201_TCP_PROTO=tcp
MY_PASS=my-secret-python
ENV_VAR=ENV_VAR_VALUE
HOSTNAME=python-app-helm-app-python-6f5956b49f-w8t9p
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```